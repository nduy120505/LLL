


CREATE DATABASE S01_QLNS
USE S01_QLNS

CREATE TABLE PHONGBAN(
MAPB NVARCHAR(10) PRIMARY KEY NOT NULL, 
TENPB NVARCHAR(100) NOT NULL, 
DIACHI NVARCHAR(100), 
SODT VARCHAR(15), 
CHUCNANG NVARCHAR(100), 
SONV INT CHECK(SONV > 0)
);

INSERT INTO PHONGBAN VALUES('PB01',N'PHÒNG TÀI CHÍNH',N'354 GIẢI PHÓNG','0362710976','TÀI CHÍNH KẾ TOÁN',20);
INSERT INTO PHONGBAN VALUES('PB02',N'PHÒNG NHÂN SỰ',N'354 GIẢI PHÓNG','0362710976','QUẢN LÝ NHÂN SỰ',20);
INSERT INTO PHONGBAN VALUES('PB03',N'PHÒNG KỸ THUẬT',N'354 GIẢI PHÓNG','0362710976','KỸ THUẬT',30);
INSERT INTO PHONGBAN VALUES('PB04',N'PHÒNG NỘI VỤ',N'354 GIẢI PHÓNG','0362710976','NỘI VỤ',36);
INSERT INTO PHONGBAN VALUES('PB05',N'PHÒNG HÀNH CHÍNH',N'354 GIẢI PHÓNG','0362710976','QUẢN LÝ HÀNH CHÍNH',65);

SELECT * FROM PHONGBAN
EXEC SP_HELP PHONGBAN

CREATE TABLE CHUCVU(
MACV NVARCHAR(10) PRIMARY KEY NOT NULL,
TENCV NVARCHAR(100) NOT NULL, 
HESOCV FLOAT NOT NULL, 
GHICHU NVARCHAR(100)
);

INSERT INTO CHUCVU VALUES('CV01',N'TRƯỞNG PHÒNG',4.5,NULL);
INSERT INTO CHUCVU VALUES('CV02',N'PHÓ TRƯỞNG PHÒNG',3.7,NULL);
INSERT INTO CHUCVU VALUES('CV03',N'NHÂN VIÊN',2.5,NULL);
INSERT INTO CHUCVU VALUES('CV04',N'THỰC TẬP SINH',1,NULL);

SELECT * FROM CHUCVU
EXEC SP_HELP CHUCVU

CREATE TABLE NHANVIEN(
MANV NVARCHAR(10) PRIMARY KEY NOT NULL, 
HOTEN NVARCHAR(100) NOT NULL, 
NGAYSINH DATE NOT NULL, 
GIOITINH NCHAR(10),
NOISINH NCHAR(20), 
HSL FLOAT, 
MAPB NVARCHAR(10) FOREIGN KEY REFERENCES PHONGBAN(MAPB),
MACV NVARCHAR(10) FOREIGN KEY REFERENCES CHUCVU(MACV)
);

INSERT INTO NHANVIEN VALUES('NV01', N'NGUYỄN QUANG DUY', '2005-05-12', 'NAM', 'HẢI PHÒNG', 3, 'PB03', 'CV01');
INSERT INTO NHANVIEN VALUES('NV02', N'VŨ THỊ THỦY', '2005-04-06', 'NỮ', 'HẢI DƯƠMG', 3, 'PB05', 'CV01');
INSERT INTO NHANVIEN VALUES('NV03', N'NÔNG MINH HẢI', '2005-05-12', 'NAM', 'HẢI PHÒNG', 3, 'PB01', 'CV01');
INSERT INTO NHANVIEN VALUES('NV04', N'NGUYỄN MINH ĐỨC', '2005-05-12', 'NAM', 'HẢI PHÒNG', 2.5, 'PB02', 'CV03');
INSERT INTO NHANVIEN VALUES('NV05', N'NGUYỄN THÀNH ĐẠT', '2005-05-12', 'NAM', 'HẢI PHÒNG', 3, 'PB04', 'CV01');
INSERT INTO NHANVIEN VALUES('NV06', N'NGUYỄN LÂM ANH', '2005-05-12', 'NỮ', 'HẢI PHÒNG', 1, 'PB01', 'CV04');
INSERT INTO NHANVIEN VALUES('NV07', N'CẤN NGỌC BÍCH', '2005-05-12', 'NỮ', 'HẢI PHÒNG', 3, 'PB01', 'CV02');

SELECT * FROM NHANVIEN
EXEC SP_HELP NHANVIEN

CREATE TABLE QUATRINH(
MAQT NVARCHAR(10) PRIMARY KEY NOT NULL, 
MANV NVARCHAR(10) FOREIGN KEY REFERENCES NHANVIEN(MANV), 
TUNGAY DATE NOT NULL, 
DENNGAY DATE NOT NULL, 
VITRI NCHAR(20) NOT NULL, 
GHICHU NCHAR(100) NOT NULL
);

INSERT INTO QUATRINH VALUES('QT01', 'NV01', '2020-12-12', '2025-12-02', 'TRƯỞNG PHÒNG', 'NHÂN VIÊN LÂU NĂM');
INSERT INTO QUATRINH VALUES('QT02', 'NV02', '2020-12-12', '2025-12-02', 'NHÂN VIÊN', 'NHÂN VIÊN XUẤT SẮC');
INSERT INTO QUATRINH VALUES('QT03', 'NV03', '2020-12-12', '2025-12-02', 'NHÂN VIÊN', 'NHÂN VIÊN LÂU NĂM');
INSERT INTO QUATRINH VALUES('QT04', 'NV04', '2020-12-12', '2025-12-02', 'NHÂN VIÊN', 'NHÂN VIÊN LÂU NĂM');
INSERT INTO QUATRINH VALUES('QT05', 'NV05', '2020-12-12', '2025-12-02', 'THỰC TẬP SINH', 'THỰC TẬP SINH TIỀM NĂNG');
INSERT INTO QUATRINH VALUES('QT06', 'NV06', '2020-12-12', '2025-12-02', 'THỰC TẬP SINH', 'THỰC TẬP SINH TIỀM NĂNG');
INSERT INTO QUATRINH VALUES('QT07', 'NV07', '2020-12-12', '2025-12-02', 'NHÂN VIÊN', 'NHÂN VIÊN LÂU NĂM');

SELECT * FROM QUATRINH
EXEC SP_HELP QUATRINH


CREATE TABLE LUONG(
MALUONG NVARCHAR(10) PRIMARY KEY NOT NULL, 
THANGNAM DATE, 
MANV NVARCHAR(10) FOREIGN KEY REFERENCES NHANVIEN(MANV), 
LUONGCB FLOAT NOT NULL, 
THUONG FLOAT, 
KHAUTRU FLOAT, 
TONGLINH FLOAT
);

INSERT INTO LUONG VALUES('ML01', '2025-12-02', 'NV01', 4000000, 300000, 200000, NULL);
INSERT INTO LUONG VALUES('ML02', '2025-12-02', 'NV02', 4000000, 300000, 200000, NULL);
INSERT INTO LUONG VALUES('ML03', '2025-12-02', 'NV03', 3500000, 300000, 200000, NULL);
INSERT INTO LUONG VALUES('ML04', '2025-12-02', 'NV04', 3000000, 300000, 200000, NULL);
INSERT INTO LUONG VALUES('ML05', '2025-12-02', 'NV05', 2500000, 300000, 200000, NULL);
INSERT INTO LUONG VALUES('ML06', '2025-12-02', 'NV06', 2000000, 300000, 200000, NULL);
INSERT INTO LUONG VALUES('ML07', '2025-12-02', 'NV07', 3000000, 300000, 200000, NULL);

SELECT * FROM LUONG
EXEC SP_HELP LUONG

CREATE OR ALTER VIEW V_TONGLUONGNV 
AS
SELECT NHANVIEN.*, LUONG.LUONGCB, LUONG.THUONG, LUONG.KHAUTRU, ( (LUONG.LUONGCB*NHANVIEN.HSL*CHUCVU.HESOCV)+LUONG.THUONG-LUONG.KHAUTRU)AS TONGTIENLINH
FROM NHANVIEN, CHUCVU, LUONG
WHERE NHANVIEN.MACV=CHUCVU.MACV 
AND NHANVIEN.MANV=LUONG.MANV

SELECT * FROM V_TONGLUONGNV

CREATE OR ALTER VIEW V_TONGNV
AS
SELECT PHONGBAN.MAPB, PHONGBAN.TENPB, PHONGBAN.DIACHI, PHONGBAN.SODT, PHONGBAN.CHUCNANG, 
	COUNT(NHANVIEN.MANV) AS SONHANVIEN
FROM NHANVIEN, PHONGBAN
WHERE NHANVIEN.MAPB = PHONGBAN.MAPB
GROUP BY PHONGBAN.MAPB, PHONGBAN.TENPB, PHONGBAN.DIACHI, PHONGBAN.SODT, PHONGBAN.CHUCNANG

SELECT * FROM V_TONGNV






CREATE OR ALTER PROC SP_SUALUONG (@MANV CHAR(10), @THUONG DECIMAL(18,2), @KHAUTRU DECIMAL(18,2))
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM LUONG WHERE MANV = @MANV)
	PRINT N'MÃ NHÂN VIÊN KHÔNG HỢP LỆ'
	ELSE
	BEGIN
	UPDATE LUONG
	SET THUONG = ISNULL(@THUONG, THUONG),
		KHAUTRU = ISNULL(@KHAUTRU, KHAUTRU)
	WHERE MANV = @MANV
	PRINT N'ĐÃ CẬP NHẬT THƯỞNG VÀ KHẤU TRỪ CỦA NHÂN VIÊN ' + @MANV
	END
END

SELECT * FROM LUONG
EXEC SP_SUALUONG 'NV01', 6000000, NULL

CREATE OR ALTER PROC SP_XOADL (@OPTION INT, @MA CHAR(10))
AS
BEGIN
--1 : XÓA CHỨC VỤ; 2: XÓA NHÂN VIÊN
	IF (@OPTION = 1)
	BEGIN
		IF NOT EXISTS (SELECT * FROM CHUCVU WHERE MACV = @MA)
		PRINT N'MÃ CHỨC VỤ KHÔNG HỢP LỆ'
		ELSE
		BEGIN
		DELETE FROM CHUCVU WHERE MACV = @MA
		PRINT N'ĐÃ XÓA CHỨC VỤ CÓ MÃ ' + @MA
		END
	END

	IF (@OPTION = 2)
	BEGIN
		IF NOT EXISTS (SELECT * FROM NHANVIEN WHERE MANV = @MA)
		PRINT N'MÃ NHÂN VIÊN KHÔNG HỢP LỆ'
		ELSE
		BEGIN
		DELETE FROM NHANVIEN WHERE MANV=@MA
		PRINT N'ĐÃ XÓA NHÂN VIÊN CÓ MÃ ' + @MA
		END
	END

	IF (@OPTION NOT IN (1, 2))
	PRINT N'LỰA CHỌN KHÔNG HƠP LỆ'
END



CREATE OR ALTER FUNCTION F_SONV(@MAPB CHAR(10))
RETURNS INT
BEGIN
	DECLARE @SONV INT
	SET @SONV = (
	SELECT COUNT(NHANVIEN.MANV)
	FROM NHANVIEN
	WHERE MAPB = @MAPB
	)
	RETURN @SONV
END

SELECT * FROM PHONGBAN

UPDATE PHONGBAN SET SONV = DBO.F_SONV(MAPB)



CREATE OR ALTER TRIGGER TRG_TONGLINH_LUONG
ON LUONG
AFTER INSERT, UPDATE, DELETE
AS
BEGIN

    UPDATE LUONG
    SET TONGLINH = (LUONG.LUONGCB * (NHANVIEN.HSL + CHUCVU.HESOCV)
                    + LUONG.THUONG - LUONG.KHAUTRU)
    FROM NHANVIEN, CHUCVU
    WHERE 
	(
		LUONG.MANV IN (SELECT MANV FROM inserted)
		OR LUONG.MANV IN (SELECT MANV FROM deleted)
	)
      AND LUONG.MANV = NHANVIEN.MANV
      AND NHANVIEN.MACV = CHUCVU.MACV
END


CREATE OR ALTER TRIGGER TRG_TONGLINH_NHANVIEN
ON NHANVIEN
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
	UPDATE LUONG
	SET TONGLINH = (LUONG.LUONGCB * (NHANVIEN.HSL + CHUCVU.HESOCV)
	+ LUONG.THUONG - LUONG.KHAUTRU)
	FROM NHANVIEN, CHUCVU
	WHERE 
	(
		NHANVIEN.MANV IN (SELECT MANV FROM inserted)
		OR NHANVIEN.MANV IN (SELECT MANV FROM deleted)
		)
	AND NHANVIEN.MANV = LUONG.MANV
	AND NHANVIEN.MACV = CHUCVU.MACV
END


CREATE OR ALTER PROC SP_THONGKELUONG (@OPTION INT, @MA CHAR(10), @THANG INT, @NAM INT)
AS
BEGIN
	IF (@OPTION = 1)
	BEGIN
		IF NOT EXISTS (SELECT MAPB FROM PHONGBAN WHERE MAPB = @MA)
		PRINT N'MÃ PHÒNG BAN KHÔNG HỢP LỆ'
		ELSE
		SELECT PHONGBAN.MAPB, PHONGBAN.TENPB, YEAR(LUONG.THANGNAM) AS NAM, MONTH(LUONG.THANGNAM) AS THANG, SUM(LUONG.TONGLINH) AS TONGLUONG
		FROM LUONG, NHANVIEN, PHONGBAN
		WHERE LUONG.MANV = NHANVIEN.MANV AND NHANVIEN.MAPB = PHONGBAN.MAPB
		AND PHONGBAN.MAPB = @MA
		GROUP BY PHONGBAN.MAPB, PHONGBAN.TENPB, YEAR(LUONG.THANGNAM), MONTH(LUONG.THANGNAM)
		HAVING YEAR(LUONG.THANGNAM) = @NAM AND MONTH(LUONG.THANGNAM) = @THANG
	END

	IF (@OPTION = 2)
	BEGIN
		IF NOT EXISTS (SELECT MACV FROM CHUCVU WHERE MACV = @MA)
		PRINT N'MÃ CHỨC VỤ KHÔNG HỢP LỆ'
		ELSE
		SELECT CHUCVU.MACV, CHUCVU.TENCV , YEAR(LUONG.THANGNAM) AS NAM, MONTH(LUONG.THANGNAM) AS THANG, SUM(LUONG.TONGLINH) AS TONGLUONG
		FROM CHUCVU, NHANVIEN, LUONG
		WHERE LUONG.MANV = NHANVIEN.MANV AND NHANVIEN.MACV = CHUCVU.MACV
		AND CHUCVU.MACV = @MA
		GROUP BY CHUCVU.MACV, CHUCVU.TENCV, YEAR(LUONG.THANGNAM), MONTH(LUONG.THANGNAM)
		HAVING YEAR(LUONG.THANGNAM) = @NAM AND MONTH(LUONG.THANGNAM) = @THANG
	END

	IF (@OPTION NOT IN(1,2))
	PRINT N'LỰA CHỌN KHÔNG HỢP LỆ'
END
GO

SELECT * FROM CHUCVU
SELECT * FROM PHONGBAN
SELECT * FROM NHANVIEN
SELECT * FROM LUONG


EXEC SP_THONGKELUONG 1, 'PB01', 1, 2025
EXEC SP_THONGKELUONG 3, 'PB01', 1, NULL
EXEC SP_THONGKELUONG 1, 'PB01', 1, NULL
EXEC SP_THONGKELUONG 2, 'CV01', 1, 2025



